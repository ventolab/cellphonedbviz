<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html lang='en' xml:lang='en' xmlns='http://www.w3.org/1999/xhtml'>
  <head>
        <title id="page_title"></title>
        <meta content='text/html; charset=utf-8' http-equiv='Content-Type' />
<!--        <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">-->
<!--        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">-->
<!--        <link rel="stylesheet" href="css/cpdbviz.css">-->
<!--        <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>-->
<!--        <script type="text/javascript" src="https://code.jquery.com/jquery-3.2.1.min.js"></script>-->
<!--        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.13.2/jquery-ui.min.js"></script>-->
<!--        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.4/d3.min.js"></script>-->
<!--        <script type="text/javascript" src="https://unpkg.com/d3fc@15.2.6/build/d3fc.js"></script>-->
<!--        <script type="text/javascript" src="https://d3js.org/d3-scale-chromatic.v3.min.js"></script>-->
<!--        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/raphael/2.3.0/raphael.min.js"></script>-->
<!--        <script src="https://cdn.jsdelivr.net/npm/pdfkit@0.10.0/js/pdfkit.standalone.js"></script>-->
<!--        <script src="https://bundle.run/blob-stream@0.1.3"></script>-->
<!--        <script src="https://cdn.jsdelivr.net/npm/svg-to-pdfkit@0.1.8/source.js"></script>-->
<!--        <script src="./js/sankey.js" type="text/javascript"></script>-->
<!--        <script src="./js/cpdbviz.js" type="text/javascript"></script>-->

        <link rel="stylesheet" href="./external/css/material_icons.css" >
        <link rel="stylesheet" href="./external/css/materialize.min.css">
        <link rel="stylesheet" href="./css/cpdbviz.css">
        <script type="text/javascript" src="./external/js/materialize.min.js"></script>
        <script type="text/javascript" src="./external/js/jquery-3.2.1.min.js"></script>
        <script type="text/javascript" src="./external/js/jquery-ui.min.js"></script>
        <script type="text/javascript" src="./external/js/d3.min.js"></script>
        <script type="text/javascript" src="./external/js/d3fc.js"></script>
        <script type="text/javascript" src="./external/js/d3-scale-chromatic.v3.min.js"></script>
        <script type="text/javascript" src="./external/js/raphael.min.js"></script>
        <script src="./js/sankey.js" type="text/javascript"></script>
        <script src="./js/cpdbviz.js" type="text/javascript"></script>
        <!-- Libraries below are needed to saving plots as PDFs    -->
        <script type="text/javascript" src="./external/js/pdfkit.standalone.js"></script>
        <script type="text/javascript" src="https://bundle.run/blob-stream@0.1.3"></script>
        <script type="text/javascript" src="./external/js/source.js"></script>
  </head>
  <script type="module">
import generateCellCellInteractionSummaryChordPlot from "./js/chord.js";

function getProjectId() {
    const queryString = window.location.search;
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get('projectid')
}

function refreshCCISummaryChordPlots() {
    const projectId = getProjectId();
    var ret = getSelectedTokens(["cci_summary_selected_classes"]);
    var selectedClasses = ret[0];
    ret = getSelectedTokens(["cci_summary_selected_microenvironments"]);
    var selectedMicroenvironments = ret[0];
    var url = './api/data/'+projectId+'/cell_cell_interaction_summary';
    if (selectedClasses) {
        url += "?classes=" + selectedClasses;
    }
    var selectedMinInteractionScore = $('#cci_summary_selected_min_score').text();
    if (cci_summary_selected_min_score) {
        var prefix;
        if (selectedClasses) {
            prefix = "&";
        } else {
            prefix = "?";
        }
        url += prefix + "min_score=" + selectedMinInteractionScore;
    }
    $.ajax({
        url: url,
        contentType: "application/json",
        dataType: 'json',
        success: function(res) {
           var min_num_ints = res['max_num_ints'];
           var max_num_ints = res['min_num_ints'];
           if (res.hasOwnProperty('microenvironment2cell_types')) {
                const microenvironment2cell_types = res['microenvironment2cell_types'];
                const map = new Map(Object.entries(microenvironment2cell_types));
                for (var i = 1; i <= 9; i++) {
                    // Remove all previous plots
                    $("#cci"+ i + "_chord").empty();
                }
                if (map.size > 0) {
                    var cnt = 1;
                    // First calculate min_num_ints and max_num_ints across the cell types in all microenvironments
                    for (let [microenvironment, cellTypes] of map.entries()) {
                        if (selectedMicroenvironments == undefined || selectedMicroenvironments.includes(microenvironment)) {
                            const num_ints_csv = filterNumInteractions(res, cellTypes, false);
                            const chordData = d3.csvParse(num_ints_csv, d3.autoType);
                            const num_ints = Array.from(new Set(chordData.flatMap(d => [parseInt(d.value)])));
                            const meMin = Math.min(...num_ints);
                            const meMax = Math.max(...num_ints);
                            // Chord plot shows nothing if number of interactions is 0, hence no point including it in the colour legend
                            if (meMin > 0 && meMin < min_num_ints) {
                                min_num_ints = meMin;
                            }
                            if (meMax > max_num_ints) {
                                max_num_ints = meMax;
                            }
                        }
                    }
                    // Now generate the plots
                    for (let [microenvironment, cellTypes] of map.entries()) {
                        if (selectedMicroenvironments == undefined || selectedMicroenvironments.includes(microenvironment)) {
                            generateCellCellInteractionSummaryChordPlot(res, cellTypes.sort(), microenvironment, cnt, min_num_ints, max_num_ints);
                            cnt++;
                            if (cnt > 9) {
                                // TODO: We currently only have up to nine slots for microenvironment-specific cci plots - to be reviewed
                                break;
                            }
                        }
                    }
                    // Generate plot across cell types also - in case the user wishes to see it
                    generateCellCellInteractionSummaryChordPlot(res, res['all_cell_types_for_sortedbyme'], "All cell types", 0, min_num_ints, max_num_ints);
                } else {
                    generateCellCellInteractionSummaryChordPlot(res, res['all_cell_types_for_sortedbyme'], "All cell types", 0, min_num_ints, max_num_ints);
                }
            } else {
                generateCellCellInteractionSummaryChordPlot(res, res['all_cell_types_for_sortedbyme'], "All cell types", 0, min_num_ints, max_num_ints);
            }
        }
     });
 }

 // Generate chord plots on first page load
 refreshCCISummaryChordPlots();

 // Regenerate chord plots when the user clicks on the 'Refresh plots' button
 document.querySelector('#refresh_cci_summary_plots').addEventListener('click', refreshCCISummaryChordPlots);

 var tabs = M.Tabs.init($('.tabs'));
 var modal = M.Modal.init($('.modal'));
 $(document).ready(function(){
    $('.tooltipped').tooltip();
  });

</script>

<!--SCRIPTS NEEDED FOR ACCESS WITHIN BODY-->
<script>
  function deactivateFilter(value, index, array){
    /*Given ID of filter to deactivate, switch off its checkbox and hide its inner contents*/
    $(`#${value}`).prop('checked', false);
    $(`#${value}-select`).hide();
  }
  function toggleFilterVisibility(filter_change_elem) {
    /*Handle selection of different filter where filters are mutually exclusive (e.g. cell type and microenvironment).
    Deactivates other filter accordingly*/

    //map of filters to other filters that should be deactivated when this is activated.
    const filter_swap_map = {"celltypefilter": ["microenvironmentfilter"], "microenvironmentfilter": ["celltypefilter"], "interactionclassfilter": ["genefilter", "genepairfilter"], "genefilter": ["interactionclassfilter", "genepairfilter"], "genepairfilter": ["interactionclassfilter", "genefilter"]}
    //1. Deactivate all other filters involved with this one (defined in filter_swap_map) if now checked.
    if (filter_change_elem.checked) {
      filter_swap_map[filter_change_elem.name].forEach(deactivateFilter);
    }
    //2. Toggle filter contents selection (if checked show else hide)
    $(`#${filter_change_elem.name}-select`).toggle();
  }
  function updateCellTypePairsPlotandDisplay(){
    /*Update the cell type pair selection matrix with current specification of cell types. Display the updated plot.
    Parameters:
      None
    Returns:
      None*/
    populate_cci_cell_type_pair_search_grid();
    var instance = M.Modal.getInstance($('#cell-type-pair-modal'));
    instance.open();
  }
</script>
  <body>
        <div style="padding-right: 30px" class="valign-wrapper right">
          <h8 >Powered by</h8>
          <a href="https://github.com/datasome/cellphonedbviz">
              <img src="img/cellphonedbviz_logo.png" alt="CellphoneDB Viz logo" width="200" height="43">
          </a>
        </div>
        <br>
        <h4 class="center" id="page_header"></h4>
        <div class="row">
              <div class="card-content center">
                  <a data-target="toc-dropdown" style="text-transform: none;" class="dropdown-trigger btn">
                    Table of contents&nbsp;<i style="vertical-align: middle;" class="large material-icons center">format_list_bulleted</i>
                </a>
              </div>
        </div>

        <!-- Dropdown ToC -->
        <ul id='toc-dropdown' class='dropdown-content'>
          <div class="toc-header left">Input dataset: overview</div>
          <li id="toc_ctcomp"><a name="#ctcomp_title" >Cell composition</a></li>
          <li id="toc_spme"><a href="#spme_title">Spatial microenvironments</a></li>
          <li class="divider"></li>
             <div class="toc-header left">CellphoneDB predictions</div>
          <li><a href="#cci_summary_title">Cell-cell Communication - Summary</a></li>
          <li><a href="#cci_search_title">Cell-cell Communication - Search</a></li>
          <li><a href="#sge_title">Single Gene Expression</a></li>
        </ul>

        <div class="row">
          <!-- Celltype composition sankey plot -->
          <div class="card">
            <div class="card-content black-text col s12">
              <span id="ctcomp_title" class="card card-title center blue-text">Cell composition</span>
              <button id="ctcomp_save_button" style="text-transform: none;" class="btn-floating waves-effect waves-light btn-small z-depth-2" onclick="downloadAsPDF('ctcomp','ctcomp_title','ctcomp_header')">
                  <i class="material-icons left tooltipped" data-tooltip="Download plot in PDF format">file_download</i>
              </button>
                <span id="celltype_composition_help" style="text-transform: none;" class="btn-floating waves-effect waves-light btn-small z-depth-2">
                  <i class="material-icons left tooltipped"
                      data-tooltip="The plot shows the mapping between different cell type characteristics specified in the file under the configuration key: 'celltype_composition'">info_outline</i>
                </span>
                <div id="ctcomp_header" hidden></div>
                <div id="ctcomp" style="width:1500px;height:700px;justify-content: center;"></div>
            </div>
          </div>
        </div>

        <!-- Spatial micro-environments plot -->
        <div class="row">
          <div class="card">
            <div class="card-content black-text col s12">
              <span id="spme_title" class="card card-title center blue-text">Spatial microenvironments</span>
              <button id="spme_save_button" style="text-transform: none;" class="btn-floating waves-effect waves-light btn-small z-depth-2" onclick="downloadAsPDF('spme','spme_title','spme_header')">
                  <i class="material-icons left tooltipped" data-tooltip="Download plot in PDF format">file_download</i>
              </button>
              <span id="spme_help" style="text-transform: none;" class="btn-floating waves-effect waves-light btn-small z-depth-2">
                <i class="material-icons left tooltipped"
                    data-tooltip="The plot shows the mapping between cell types and microenvironments specified in the file under the configuration key: 'microenvironments'">info_outline</i>
              </span>
              <div id="spme_header" hidden>Cell Type - Microenvironment</div>
              <div id="spme" style="width:800px"></div>
            </div>
          </div>
        </div>
        
        <!---FILTERS FOR CELL-CELL COMMUNICATION SUMMARY-->
        <div class="col s12">
          <div class="card">
                <ul class="collapsible">
                    <li>
                      <div class="collapsible-header center search-header"><i class="material-icons">expand_more</i>Manage filters</div>
                      <div class="collapsible-body">
                          <div class="switch" style="padding-left: 30px;">
                            <label>
                              <span class="black-text text-lighten-10 switch-label">Show heatmaps</span>
                              <input id="cci_summary_switch" type="checkbox">
                              <span id="cci_summary_switch_lever" class="lever"></span>
                              <span class="black-text text-lighten-10 switch-label">Show chord plots</span>
                            </label>
                          </div>
                          <div id="cci_summary_show_all_celltypes_div" style="padding-top: 20px; padding-left: 30px;" hidden>
                              <label>
                                  <input id="cci_summary_show_all_celltypes" type="checkbox" class="filled-in"/>
                                  <span id="cci_summary_show_all_celltypes_label">Show all cell types</span>
                              </label>
                          </div>
                          <div>
                              <div id="cci_summary_class_filter_div" style="padding-left: 20px; padding-right: 20px" hidden>
                                  <div class="input-field">
                                    <input style="padding-top: 30px;" type="text" id="cci_summary_class_input" placeholder="">
                                    <label style="padding-top: 30px;" for="cci_summary_class_input" class="black-text text-lighten-10 search-input-label">Filter interactions by class</label>
                                  </div>
                                  <div style="padding-bottom: 20px;" class="cci_summary_selected_classes"></div>
                              </div>
                              <div id="cci_summary_modality_filter_div" style="padding-left: 20px; padding-right: 20px" hidden>
                                  <div class="input-field">
                                    <input style="padding-top: 30px;" type="text" id="cci_summary_modality_input" placeholder="">
                                    <label style="padding-top: 30px;" for="cci_summary_modality_input" class="black-text text-lighten-10 search-input-label">Filter interactions by modality</label>
                                  </div>
                                  <div style="padding-bottom: 20px;" class="cci_summary_selected_modalities"></div>
                              </div>
                              <div id="cci_summary_microenvironment_div" style="padding-left: 20px; padding-right: 20px" hidden>
                                  <div class="input-field">
                                    <input style="padding-top: 30px;" type="text" id="cci_summary_microenvironment_input" placeholder="">
                                    <label style="padding-top: 10px;" for="cci_summary_microenvironment_input" class="black-text text-lighten-10 search-input-label">Select microenvironments to plot</label>
                                  </div>
                                  <div class="cci_summary_selected_microenvironments" style="padding-bottom: 10px;" ></div>
                              </div>
                              <div id="cci_summary_score_div" style="padding-left: 20px; padding-right: 800px; padding-top: 10px" hidden>
                                  <div class="range-field">
                                    <label style="padding-top: 10px; font-size: 14px;" for="cci_summary_score_input" class="black-text text-lighten-10 input-label">Filter interactions by minimum score</label>
                                    <input type="range" value="0" id="cci_summary_score_input" min="0" max="100" placeholder=""/>
                                    <span>Minimum interaction score: <label id="cci_summary_selected_min_score" style="font-size: 14px;" class="black-text text-lighten-10">0</label></span>
                                  </div>
                              </div>
                              <div id="cci_summary_buttons_div" style="padding-left: 20px; padding-right: 20px; padding-bottom: 20px; padding-top: 20px" hidden>
                                  <button id="refresh_cci_summary_plots" style="text-transform: none;" class="btn waves-effect waves-light btn-small z-depth-2" onclick="refreshCCISummaryPlots();">Refresh plots
                                        <i class="material-icons right">refresh</i>
                                  </button>
                                  <button id="clear_cci_summary_filter" style="text-transform: none;" class="btn waves-effect waves-light btn-small z-depth-2" onclick="clearCCISummaryFilters()">Clear filters&nbsp;
                                        <i class="material-icons right">clear_all</i>
                                  </button>
                              </div>
                          </div>
                      </div>
                    </li>
                </ul>
              
            </div>  <!-- <div class="card"> -->
        </div> <!-- <div class="col s12"> -->
        <!--SINGLE GENE EXPRESSION FILTERS-->
        <div class="col s12">
          <div class="card">
              <div class="row">
                  <div id="search_results" hidden>
                    <div class="card">
                      <div class="card-content black-text col s12">
                        <div id="search_results_table"  class="col s12">
                          <span id="search_results_title" class="card-title"></span>
                          <div hidden id="search_results_csv"></div>
                          <div class="divider"></div>
                            <span style="color: blue"><i>Click on an interaction partner name for more information.</i></span>
                            <p></p>
                        </div>
                      </div>
                    </div>
                  </div>


                  <div style="padding-left: 35px" class="col s12 m3 l3">
                      <ul class="collapsible">
                        <li>
                          <div class="collapsible-header center search-header"><i class="material-icons">expand_more</i>Manage filters</div>
                          <div class="collapsible-body">

                            <div id="num_all_cell_type_pairs" hidden></div>
                            <div class="row">
                              <div class="col s12">
                                <div class="row">
                                  <div>
                                      <div class="section center">
                                        <button id="refresh_sge_plot_btn" style="text-transform: none;" class="btn waves-effect waves-light btn-small z-depth-2" onclick="refreshSGEPlot()">Refresh plot
                                            <i class="material-icons right">refresh</i>
                                        </button>
                                        <button id="clear_sge_filters" style="text-transform: none;" class="btn waves-effect waves-light btn-small z-depth-2" onclick="clearSGEFilters()">Clear filters&nbsp;
                                            <i class="material-icons right">clear_all</i>
                                        </button>
                                      </div>
                                      <div id="sge_microenvironment_sel" class="input-field">
                                        <input style="padding-top: 30px;" type="text" id="sge_microenvironment_input" placeholder="Microenvironment">
                                        <label style="padding-top: 10px;" for="sge_microenvironment_input" class="black-text text-lighten-10 search-input-label">Filter cell types by microenvironment</label>
                                      </div>
                                      <div class="sge_selected_microenvironments"></div>
                                      <div style="padding-top: 20px;"></div>
                                      <div class="input-field">
                                        <input style="padding-top: 30px;" type="text" id="sge_celltype_input" placeholder="Cell type">
                                        <label style="padding-top: 30px;" for="sge_celltype_input" class="black-text text-lighten-10 search-input-label">Add cell types to the plot</label>
                                      </div>
                                      <div class="sge_selected_celltypes"></div>
                                      <div style="padding-top: 10px;">
                                          <button id="sge_select_all_celltypes" style="text-transform: none;" class="btn waves-effect waves-light btn-small z-depth-2" onclick="selectAllCellTypes('single_gene_expression')">Select all cell types
                                              <i class="material-icons right">done_all</i>
                                          </button>
                                      </div>
                                      <div style="padding-top: 20px;"></div>
                                      <div class="input-field">
                                        <input style="padding-top: 30px;" type="text" id="sge_gene_input" placeholder="Gene name">
                                        <label style="padding-top: 30px;" for="sge_gene_input" class="black-text text-lighten-10 search-input-label">Add genes to the plot&nbsp;&nbsp;
                                            <span style="text-transform: none;" class="btn-floating waves-effect waves-light btn-small z-depth-2">
                                                <i id="sge_gene_input_help" class="material-icons left tooltipped" data-tooltip="Select all genes in a family by selecting e.g. WNT* or TNFR* from the dropdown">info_outline</i>
                                            </span>
                                        </label>
                                      </div>
                                      <div class="sge_selected_genes"></div>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                        </li>
                      </ul>
                    </div>
              </div> <!-- <div class="row"> -->
          </div> <!-- <div class="card"> -->
        </div> <!-- <div class="col s12"> -->

        <!--========================
          CELLPHONEDB PREDICTION PANE
          ========================-->

        <div class="card border-card" id="cci-display-box">
          <!--TABS for CellphoneDB predictions-->
          <div id="cci-tabs-row">
              <ul class="tabs center" id="cci-tabs">
                <li class="tab col s3 blue-text text-darken-4"><a class="active" href="#cci-summary">Summary</a></li>
                <li class="tab col s3 blue-text text-darken-4"><a href="#cci-search">Search</a></li>
                <li class="tab col s3 blue-text text-darken-4"><a href="#single-gene-expr">Single Gene Expression</a></li>
              </ul>
          </div>
          <!--CONFIG PANEL for CellphoneDB predictions-->
          <div class="row" id="cci-display-panel">
            <div id="cci-config" class="col s3">
              <!--Buttons to a) apply current filter selection and b) remove all filters from the side panel.-->
              <div class="row" id="apply-reset-filters">
                <div class="section">
                  <div class="center-align">
                    <button id="refresh_cci_search_plot_btn" style="text-transform: none;" class="btn waves-effect waves-light btn-small z-depth-2 green lighten-1" onclick="refreshCCISearchPlot()">Refresh plot
                        <i class="material-icons right">refresh</i>
                    </button>
                    <button id="clear_cci_search_filters" style="text-transform: none;" class="btn waves-effect waves-light btn-small z-depth-2 red lighten-1" onclick="clearCCISearchFilters()">Clear filters
                        <i class="material-icons right">clear_all</i>
                    </button>
                  </div>
                </div>
              </div>
              <div class="row">
                <ul class="collapsible">
                  <!--Option 1: Filter cell types (sub-options are mutually exclusive)-->
                  <li>
                    <div class="collapsible-header"><i class="material-icons">class</i>SELECT cell types</div>
                    <div class="collapsible-body filter-menu-padding filter-layer-one">
                      <div>

                        <!--Option 1a: Filter by cell type (and cell type pair)-->
                        <label id="filter-by-cell-type">
                          <input type="checkbox" class="filled-in" name="celltypefilter" id="celltypefilter" checked onchange="toggleFilterVisibility(this)"/>
                          <span class="outer-filter-nest">By Cell Type</span>
                        </label>
                        <div class="filter-layer-two" id="celltypefilter-select">
                          <!--Search (autocomplete), select all, clear all for cell type filtering-->
                          <div class="row no-margin-bottom">
                            <div class="input-field col l7 m12 s12">
                              <input type="text" id="cci_search_celltype_input" placeholder="Cell type">
                            </div>
                            <div class="input-field col l2 m6 s6">
                              <button id="cci_search_select_all_celltypes"
                                class="btn tooltipped waves-effect waves-light btn-small z-depth-2"
                                data-position="bottom" data-tooltip="Select all cell types"
                                onclick="selectAllCellTypes('cell_cell_interaction_search')"
                              >
                                <i class="material-icons">done_all</i>
                              </button>
                            </div>
                            <div class="input-field col l2 m6 s6">
                              <button id="clear_cci_search_cell_type_filters"
                                class="btn tooltipped waves-effect waves-light btn-small z-depth-2"
                                data-position="bottom" data-tooltip="Clear all cell types"
                                onclick="clearCCISearchCellTypeFilters()"
                              >
                                <i class="material-icons">clear_all</i>
                              </button>
                            </div>
                          </div>
                          <!--Embedded list of cell types to choose from-->
                          <div class="cci_search_selected_celltypes"></div>
                          <button id="toggle_cell_pair_grid_btn" style="text-transform: none;" class="btn waves-effect waves-light btn-small z-depth-2 margin-top" onclick="updateCellTypePairsPlotandDisplay()">
                            <span id="toggle_show_cell_type_pair_grid">Advanced search</span>
                            <i class="material-icons right">apps</i>
                          </button>
                        </div>
                        <div id="cell-type-pair-modal" class="modal modal-fixed-footer">
                          <div class="modal-content">
                            <h3 class="center-align">Select cell type pairs</h3>
                            <p>Select specific interactions between cell types on this grid. Incoming interactions are the y-axis and outgoing interactions are the x-axis. A blue square indicates a selected interaction between cell type pairs. White means that the interaction has not been selected. A grey square indicates that the interaction does not exist between the relevant cell types.</p>
                            <div id="select_cell_type_pairs_grid"></div>
                          </div>
                          <div class="modal-footer">
                            <button class="modal-close waves-effect waves-green btn-flat">Close</button>
                          </div>
                        </div>
                        <div class="divider filter-divider"></div>

                        <!--Option 1b: Filter by microenvironment-->
                        <label id="filter-by-microenvironment">
                          <input type="checkbox" class="filled-in" name="microenvironmentfilter" id="microenvironmentfilter" onchange="toggleFilterVisibility(this)"/>
                          <span class="outer-filter-nest">By Microenvironment</span>
                        </label>
                        <div class="filter-layer-two" id="microenvironmentfilter-select" hidden>
                          <!--Search microenvironment (autocomplete)-->
                          <div id="cci_search_microenvironment_sel" class="input-field filter-search-and-buttons">
                            <input style="padding-top: 30px;" type="text" id="cci_search_microenvironment_input" placeholder="Microenvironment">
                            <label style="padding-top: 30px;" for="cci_search_microenvironment_input" class="black-text text-lighten-10 search-input-label">Filter cell types by microenvironment</label>
                          </div>
                          <!--Embedded list of microenvironments to choose from-->
                          <div class="cci_search_selected_microenvironments"></div>
                        </div>
                      </div>
                    </div>
                  </li>
                  <!--Option 2: Select interactions (sub-options are mutually exclusive)-->
                  <li>
                    <div class="collapsible-header"><i class="material-icons">compare_arrows</i>SELECT interactions</div>
                    <div class="collapsible-body filter-menu-padding filter-layer-one">
                      <div>
                        <!--Option 2a: Filter by interaction class-->
                        <label id="filter-by-interaction-class">
                          <input type="checkbox" class="filled-in" name="interactionclassfilter" id="interactionclassfilter" onchange="toggleFilterVisibility(this)"/>
                          <span class="outer-filter-nest">By Interaction Classification</span>
                        </label>
                        <div class="filter-layer-two" id="interactionclassfilter-select" hidden>
                          <!--Search interaction classes (autocomplete)-->
                          <div id="cci_search_class_filter_div" class="input-field" hidden>
                            <input type="text" id="cci_search_class_input" placeholder="Interaction class">
                          </div>
                          <!--Embedded list of interaction classes to choose from-->
                          <div class="cci_search_selected_classes"></div>
                        </div>
                        <div class="divider filter-divider"></div>

                        <!--Option 2b: Filter by gene-->
                        <label id="filter-by-gene">
                          <input type="checkbox" class="filled-in" name="genefilter" id="genefilter" onchange="toggleFilterVisibility(this)"/>
                          <span class="outer-filter-nest">By Gene</span>
                        </label>
                        <div class="filter-layer-two" id="genefilter-select" hidden>
                          <!--Search genes (autocomplete) - note there is an option to select all genes by family here.-->
                          <div class="input-field">
                            <input style="padding-top: 20px;" type="text" id="cci_search_gene_input" placeholder="Gene">
                            <label style="padding-top: 20px;" for="cci_search_gene_input" class="black-text text-lighten-10 search-input-label">Search Genes&nbsp;&nbsp;
                                <span style="text-transform: none;" class="btn-floating waves-effect waves-light btn-small z-depth-2">
                                    <i id="cci_search_gene_input_help" class="material-icons left tooltipped" data-tooltip="Select all genes in a family by selecting e.g. WNT* or TNFR* from the dropdown">info_outline</i>
                                </span>
                            </label>
                          </div>
                          <!--Embedded list of genes to choose from-->
                          <div class="cci_search_selected_genes"></div>
                        </div>
                        <div class="divider filter-divider"></div>

                        <!--Option 2c: Filter by gene pair-->
                        <label id="filter-by-gene-pair">
                          <input type="checkbox" class="filled-in" name="genepairfilter" id="genepairfilter" checked onchange="toggleFilterVisibility(this)"/>
                          <span class="outer-filter-nest">By Gene Pair</span>
                        </label>
                        <div class="filter-layer-two" id="genepairfilter-select">
                        <!--Select top X/clear all interaction class filters-->
                        <div style="padding-top: 10px;">
                          <!-- Default: select top 10 interacting pairs corresponding to the selected cell type pairs-->
                          <div id="interacting_pairs_selection_logic" hidden>10</div>
                          <a class="btn waves-effect waves-light btn-small z-depth-2 dropdown-trigger" style="text-transform: none;" data-target="cci_search_select_relevant_interactions_dropdown">
                              Select significant/relevant interactions&nbsp;<i style="vertical-align: middle;" class="material-icons white-text">pageview</i></a>
                          <ul id="cci_search_select_relevant_interactions_dropdown" class="dropdown-content" tabindex="0">
                              <li><a href="javascript:refreshCCISearchPlot('10');">Top 10</a></li>
                              <li><a href="javascript:refreshCCISearchPlot('20');">Top 20</a></li>
                              <li><a href="javascript:refreshCCISearchPlot('40');">Top 40</a></li>
                              <li><a href="javascript:refreshCCISearchPlot('all');">All</a></li>
                          </ul>
                          <button id="clear_cci_search_interaction_filters" style="text-transform: none;" class="btn waves-effect waves-light btn-small z-depth-2" onclick="clearCCISearchInteractionFilters()">Clear interaction filters
                                <i class="material-icons right">clear_all</i>
                          </button>
                          <div id="cci_search_sel_ips_logic_spinner" class="container center" hidden>
                              <div class="preloader-wrapper active center">
                                <div class="spinner-layer spinner-red-only">
                                  <div class="circle-clipper left">
                                    <div class="circle"></div>
                                  </div><div class="gap-patch">
                                    <div class="circle"></div>
                                  </div><div class="circle-clipper right">
                                    <div class="circle"></div>
                                  </div>
                                </div>
                              </div>
                          </div>
                          <div id="cci_search_sel_ips_request_error" class="container center red-text" style="padding-top: 20px;" hidden></div>
                        </div>
                          <!--Search gene pairs (autocomplete)-->
                          <div class="input-field">
                            <input type="text" id="cci_search_interaction_input" placeholder="Gene Pair">
                          </div>
                          <!--Embedded list of gene pairs to choose from-->
                          <div class="cci_search_selected_interactions"></div>
                        </div>
                      </div>
                    </div>
                  </li>
                </ul>
              </div>
            </div>

            <!--DISPLAY PLOTS-->
            <!---Cell-Cell Communication Summary Display-->
            <div id="cci-summary" class="col s9 cci-display">
              <h4 id="cci_summary_title">Cell-cell Communication - Summary</h4>
              <div id="cci_summary_spinner" class="container center" hidden>
                <div class="preloader-wrapper active center">
                  <div class="spinner-layer spinner-red-only">
                    <div class="circle-clipper left">
                      <div class="circle"></div>
                    </div><div class="gap-patch">
                      <div class="circle"></div>
                    </div><div class="circle-clipper right">
                      <div class="circle"></div>
                    </div>
                  </div>
                </div>
              </div>
              <div id="cci_summary_error" class="container center red-text" style="padding-top: 20px;" hidden></div>
              <div class="row">
                <!-- Cell cell interaction plot - All cell types-->
                <div id="cci0_div" hidden>
                  <div class="col s12 m6 l6">
                    <div class="card">
                      <div class="card-content black-text col s12">
                        <button style="text-transform: none;" class="btn-floating waves-effect waves-light btn-small z-depth-2" onclick="downloadAsPDF('cci0','cci_summary_title','cci0_header')">
                          <i class="material-icons left tooltipped" data-tooltip="Download plot in PDF format">file_download</i>
                        </button>
                          <span id="cci_summary_all_celltypes_help" style="text-transform: none;" class="btn-floating waves-effect waves-light btn-small z-depth-2">
                            <i class="material-icons left tooltipped"
                          data-tooltip="The plot shows the number of significant interactions between each cell type pair.
                          <br>The data comes from files specified in the configuration keys: 'analysis_means', 'relevant_interactions'
                          (and 'microenvironments' and 'interaction_scores' if applicable)">info_outline</i>
                          </span>
                        <div id="cci0_header" hidden></div>
                          <div id="cci0" style="width:1000px"></div>
                          <div id="cci0_chord" style="width:1000px" hidden></div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="row">
                <!-- Cell cell interaction plot - Microenvironment 1 -->
                <div id="cci1_div" hidden>
                  <div class="col s12 m4 l4">
                    <div class="card">
                      <div class="card-content black-text col s12">
                        <button style="text-transform: none;" class="btn-floating waves-effect waves-light btn-small z-depth-2" onclick="downloadAsPDF('cci1','cci_summary_title','cci1_header')">
                          <i class="material-icons left tooltipped" data-tooltip="Download plot in PDF format">file_download</i>
                        </button>
                          <span id="cci_summary_me1_help" style="text-transform: none;" class="btn-floating waves-effect waves-light btn-small z-depth-2">
                            <i class="material-icons left tooltipped"
                          data-tooltip="The plot shows the number of significant interactions between each cell type pair in this microenviroment.
                          <br>The data comes from files specified in the configuration keys: 'analysis_means', 'relevant_interactions', 'microenvironments'
                          (and 'interaction_scores' if applicable)">info_outline</i>
                          </span>
                        <div id="cci1_header" hidden></div>
                          <div id="cci1" style="width:400px"></div>
                          <div id="cci1_chord" style="width:400px" hidden></div>
                      </div>
                    </div>
                  </div>
                </div>
                <!-- Cell cell interaction plot - Microenvironment 2 -->
                <div id="cci2_div" hidden>
                  <div class="col s12 m4 l4">
                    <div class="card">
                      <div class="card-content black-text col s12">
                        <button style="text-transform: none;" class="btn-floating waves-effect waves-light btn-small z-depth-2" onclick="downloadAsPDF('cci2','cci_summary_title','cci2_header')">
                          <i class="material-icons left tooltipped" data-tooltip="Download plot in PDF format">file_download</i>
                        </button>
                          <span id="cci_summary_me2_help" style="text-transform: none;" class="btn-floating waves-effect waves-light btn-small z-depth-2">
                            <i class="material-icons left tooltipped"
                          data-tooltip="The plot shows the number of significant interactions between each cell type pair in this microenviroment.
                          <br>The data comes from files specified in the configuration keys: 'analysis_means', 'relevant_interactions', 'microenvironments'
                          (and 'interaction_scores' if applicable)">info_outline</i>
                          </span>
                          <div id="cci2_header" hidden></div>
                          <div id="cci2" style="width:400px"></div>
                          <div id="cci2_chord" style="width:400px" hidden></div>
                      </div>
                    </div>
                  </div>
                </div>
                <!-- Cell cell interaction plot - Microenvironment 3 -->
                <div id="cci3_div" hidden>
                  <div class="col s12 m4 l4">
                    <div class="card">
                      <div class="card-content black-text col s12">
                        <button style="text-transform: none;" class="btn-floating waves-effect waves-light btn-small z-depth-2" onclick="downloadAsPDF('cci3','cci_summary_title','cci3_header')">
                          <i class="material-icons left tooltipped" data-tooltip="Download plot in PDF format">file_download</i>
                        </button>
                          <span id="cci_summary_me3_help" style="text-transform: none;" class="btn-floating waves-effect waves-light btn-small z-depth-2">
                            <i class="material-icons left tooltipped"
                          data-tooltip="The plot shows the number of significant interactions between each cell type pair in this microenviroment.
                          <br>The data comes from files specified in the configuration keys: 'analysis_means', 'relevant_interactions', 'microenvironments'
                          (and 'interaction_scores' if applicable)">info_outline</i>
                          </span>
                        <div id="cci3_header" hidden></div>
                          <div id="cci3" style="width:400px"></div>
                          <div id="cci3_chord" style="width:400px" hidden></div>
                      </div>
                    </div>
                  </div>
                </div>
              </div> <!-- <div class="row"> -->

              <div class="row">
                <!-- Cell cell interaction plot - Microenvironment 4 -->
                <div id="cci4_div" hidden>
                  <div class="col s12 m4 l4">
                    <div class="card">
                      <div class="card-content black-text col s12">
                        <button style="text-transform: none;" class="btn-floating waves-effect waves-light btn-small z-depth-2" onclick="downloadAsPDF('cci4','cci_summary_title','cci4_header')">
                          <i class="material-icons left tooltipped" data-tooltip="Download plot in PDF format">file_download</i>
                        </button>
                          <span id="cci_summary_me4_help" style="text-transform: none;" class="btn-floating waves-effect waves-light btn-small z-depth-2">
                            <i class="material-icons left tooltipped"
                          data-tooltip="The plot shows the number of significant interactions between each cell type pair in this microenviroment.
                          <br>The data comes from files specified in the configuration keys: 'analysis_means', 'relevant_interactions', 'microenvironments'
                          (and 'interaction_scores' if applicable)">info_outline</i>
                          </span>
                        <div id="cci4_header" hidden></div>
                          <div id="cci4" style="width:400px"></div>
                          <div id="cci4_chord" style="width:400px" hidden></div>
                      </div>
                    </div>
                  </div>
                </div>
                <!-- Cell cell interaction plot - Microenvironment 5 -->
                <div id="cci5_div" hidden>
                  <div class="col s12 m4 l4">
                    <div class="card">
                      <div class="card-content black-text col s12">
                        <button style="text-transform: none;" class="btn-floating waves-effect waves-light btn-small z-depth-2" onclick="downloadAsPDF('cci5','cci_summary_title','cci5_header')">
                          <i class="material-icons left tooltipped" data-tooltip="Download plot in PDF format">file_download</i>
                        </button>
                          <span id="cci_summary_me5_help" style="text-transform: none;" class="btn-floating waves-effect waves-light btn-small z-depth-2">
                            <i class="material-icons left tooltipped"
                          data-tooltip="The plot shows the number of significant interactions between each cell type pair in this microenviroment.
                          <br>The data comes from files specified in the configuration keys: 'analysis_means', 'relevant_interactions', 'microenvironments'
                          (and 'interaction_scores' if applicable)">info_outline</i>
                          </span>
                        <div id="cci5_header" hidden></div>
                          <div id="cci5" style="width:400px"></div>
                          <div id="cci5_chord" style="width:400px" hidden></div>
                      </div>
                    </div>
                  </div>
                </div>
                <!-- Cell cell interaction plot - Microenvironment 6 -->
                <div id="cci6_div" hidden>
                  <div class="col s12 m4 l4">
                    <div class="card">
                      <div class="card-content black-text col s12">
                        <button style="text-transform: none;" class="btn-floating waves-effect waves-light btn-small z-depth-2" onclick="downloadAsPDF('cci6','cci_summary_title','cci6_header')">
                          <i class="material-icons left tooltipped" data-tooltip="Download plot in PDF format">file_download</i>
                        </button>
                          <span id="cci_summary_me6_help" style="text-transform: none;" class="btn-floating waves-effect waves-light btn-small z-depth-2">
                            <i class="material-icons left tooltipped"
                          data-tooltip="The plot shows the number of significant interactions between each cell type pair in this microenviroment.
                          <br>The data comes from files specified in the configuration keys: 'analysis_means', 'relevant_interactions', 'microenvironments'
                          (and 'interaction_scores' if applicable)">info_outline</i>
                          </span>
                        <div id="cci6_header" hidden></div>
                          <div id="cci6" style="width:400px"></div>
                          <div id="cci6_chord" style="width:400px" hidden></div>
                      </div>
                    </div>
                  </div>
                </div>
              </div> <!-- <div class="row"> -->
              <div class="row">
                <!-- Cell cell interaction plot - Microenvironment 7 -->
                <div id="cci7_div" hidden>
                  <div class="col s12 m4 l4">
                    <div class="card">
                      <div class="card-content black-text col s12">
                        <button style="text-transform: none;" class="btn-floating waves-effect waves-light btn-small z-depth-2" onclick="downloadAsPDF('cci7','cci_summary_title','cci7_header')">
                          <i class="material-icons left tooltipped" data-tooltip="Download plot in PDF format">file_download</i>
                        </button>
                          <span id="cci_summary_me7_help" style="text-transform: none;" class="btn-floating waves-effect waves-light btn-small z-depth-2">
                            <i class="material-icons left tooltipped"
                          data-tooltip="The plot shows the number of significant interactions between each cell type pair in this microenviroment.
                          <br>The data comes from files specified in the configuration keys: 'analysis_means', 'relevant_interactions', 'microenvironments'
                          (and 'interaction_scores' if applicable)">info_outline</i>
                          </span>
                        <div id="cci7_header" hidden></div>
                          <div id="cci7" style="width:400px"></div>
                          <div id="cci7_chord" style="width:400px" hidden></div>
                      </div>
                    </div>
                  </div>
                </div>
                <!-- Cell cell interaction plot - Microenvironment 8 -->
                <div id="cci8_div" hidden>
                  <div class="col s12 m4 l4">
                    <div class="card">
                      <div class="card-content black-text col s12">
                        <button style="text-transform: none;" class="btn-floating waves-effect waves-light btn-small z-depth-2" onclick="downloadAsPDF('cci8','cci_summary_title','cci8_header')">
                          <i class="material-icons left tooltipped" data-tooltip="Download plot in PDF format">file_download</i>
                        </button>
                          <span id="cci_summary_me8_help" style="text-transform: none;" class="btn-floating waves-effect waves-light btn-small z-depth-2">
                            <i class="material-icons left tooltipped"
                          data-tooltip="The plot shows the number of significant interactions between each cell type pair in this microenviroment.
                          <br>The data comes from files specified in the configuration keys: 'analysis_means', 'relevant_interactions', 'microenvironments'
                          (and 'interaction_scores' if applicable)">info_outline</i>
                          </span>
                        <div id="cci8_header" hidden></div>
                          <div id="cci8" style="width:400px"></div>
                          <div id="cci8_chord" style="width:400px" hidden></div>
                      </div>
                    </div>
                  </div>
                </div>
                <!-- Cell cell interaction plot - Microenvironment 9 -->
                <div id="cci9_div" hidden>
                  <div class="col s12 m4 l4">
                    <div class="card">
                      <div class="card-content black-text col s12">
                        <button style="text-transform: none;" class="btn-floating waves-effect waves-light btn-small z-depth-2" onclick="downloadAsPDF('cci9','cci_summary_title','cci9_header')">
                          <i class="material-icons left tooltipped" data-tooltip="Download plot in PDF format">file_download</i>
                        </button>
                          <span id="cci_summary_me9_help" style="text-transform: none;" class="btn-floating waves-effect waves-light btn-small z-depth-2">
                            <i class="material-icons left tooltipped"
                          data-tooltip="The plot shows the number of significant interactions between each cell type pair in this microenviroment.
                          <br>The data comes from files specified in the configuration keys: 'analysis_means', 'relevant_interactions', 'microenvironments'
                          (and 'interaction_scores' if applicable)">info_outline</i>
                          </span>
                        <div id="cci9_header" hidden></div>
                          <div id="cci9" style="width:400px"></div>
                          <div id="cci9_chord" style="width:400px" hidden></div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!---Cell-Cell Communication Search Display-->
            <div id="cci-search" class="col s9 cci-display">
              <h4 id="cci_search_title">Cell-cell Communication - Search</h4>
              <div id="cci_search_spinner" class="container center">
                <div class="preloader-wrapper active center">
                  <div class="spinner-layer spinner-red-only">
                    <div class="circle-clipper left">
                      <div class="circle"></div>
                    </div><div class="gap-patch">
                      <div class="circle"></div>
                    </div><div class="circle-clipper right">
                      <div class="circle"></div>
                    </div>
                  </div>
                </div>
              </div>
              <button style="text-transform: none;" class="btn-floating waves-effect waves-light btn-small z-depth-2" onclick="downloadAsPDF('cci_search','cci_search_title','cci_search_header')">
                <i class="material-icons left tooltipped" data-tooltip="Download plot in PDF format">file_download</i>
              </button>
              <span style="text-transform: none;" class="btn-floating waves-effect waves-light btn-small z-depth-2">
                <i id="interacting_pair_help" class="material-icons left tooltipped" data-tooltip=
                        "This plot shows significant interactions across the selected cell type/interacting pairs.
                        <br>The data comes from files specified in the configuration keys: 'analysis_means', 'relevant_interactions'
                (and 'microenvironments', 'interaction_scores' and 'pvalues' if applicable respectively)<p />"
                >info_outline</i>
              </span>
              <div style="padding-top: 20px;">
                <span class="black-text text-lighten+10 switch-label">Show: &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
                <label>
                  <input name="cci_search_radio" value="means" type="radio" class="with-gap" checked>
                  <span class="black-text text-lighten-10 switch-label">mean expressions</span>
                </label>
                <label>
                  <input name="cci_search_radio" value="zscores" type="radio" class="with-gap">
                  <span class="black-text text-lighten-10 switch-label">z-scores</span>
                </label>
                <label id="rb_scores" hidden>
                  <input name="cci_search_radio" value="scores" type="radio" class="with-gap">
                  <span class="black-text text-lighten-10 switch-label">scores</span>
                </label>
              </div>
              <div class="switch" style="padding-top: 20px;">
                <label>
                  <span class="black-text text-lighten+10 switch-label">Sort interacting pairs:&nbsp;&nbsp;&nbsp;</span>
                  <span class="black-text text-lighten-10 switch-label">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;by expression</span>
                  <input id="cci_search_sort_ips_switch" type="checkbox">
                  <span class="lever"></span>
                  <span class="black-text text-lighten-10 switch-label">alphabetically</span>
                </label>
              </div>
              <div id="cci_search_header" hidden></div>
              <div id="cci_search_sidenav_content"></div>
              <div id="cci_search" style="width:1400px"></div>
            </div>

            <!--Single Gene Expression Display-->
            <div id="single-gene-expr" class="col s9 cci-display">
              <h4 id="sge_title">Single Gene Expression</h4>
              <div class="col s12 m9 l9 push-s1">
                <div id="sge_spinner" class="container center" hidden>
                  <div class="preloader-wrapper active center">
                    <div class="spinner-layer spinner-red-only">
                      <div class="circle-clipper left">
                        <div class="circle"></div>
                      </div><div class="gap-patch">
                        <div class="circle"></div>
                      </div><div class="circle-clipper right">
                        <div class="circle"></div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="card">
                    <div class="card-content black-text col s12">
                      <button style="text-transform: none;" class="btn-floating waves-effect waves-light btn-small z-depth-2" onclick="downloadAsPDF('sge','sge_title','sge_header')">
                          <i class="material-icons left tooltipped" data-tooltip="Download plot in PDF format">file_download</i>
                      </button>
                      <span id="sge_help" style="text-transform: none;" class="btn-floating waves-effect waves-light btn-small z-depth-2">
                        <i class="material-icons left tooltipped"
                            data-tooltip="The plot shows mean expressions of the genes/complexes and cell types/microenvironments selected in the filter. The data comes from files specified in the configuration keys: 'deconvoluted_result', 'deconvoluted_percents' and 'microenvironments'.">info_outline</i>
                      </span>
                      <div id="sge_header" hidden></div>
                        <div id="sge" style="width:1000px"></div>
                    </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="valign-wrapper">
          <h8 style="padding-left: 30px">Powered by</h8>
          <a href="https://github.com/datasome/cellphonedbviz">
              <img src="img/cellphonedbviz_logo.png" alt="CellphoneDB Viz logo" width="200" height="43">
          </a>
        </div>
  </body>
</html>
